{# templates/vehicle_maintenance_home.html #}
{% extends "base.html" %}

{% block title %}Fleet Triage{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/fleet_overview.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4 fleet-overview">

  <!-- Header -->
  <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-2 mb-3">
    <div class="me-auto">
      <h1 class="h4 mb-1 d-flex align-items-center gap-2">
        <i class="bi bi-truck"></i>
        Fleet Overview
      </h1>
      <div class="text-muted small" id="fleet-updated">Updated —</div>
    </div>

    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-sm btn-primary" href="{{ url_for('fleet.vehicle_inspection') }}">
        <i class="bi bi-clipboard-check me-1"></i> New Inspection
      </a>

      <button class="btn btn-sm btn-outline-secondary" id="fleet-refresh">
        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
      </button>

      <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="bi bi-sliders me-1"></i> Settings
        </button>
        <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 280px;">
          <div class="mb-2">
            <label class="form-label small mb-1">Inspection overdue after (days)</label>
            <input type="number" class="form-control form-control-sm" id="threshold-inspection-days" value="7" min="1" step="1">
          </div>
          <div class="d-grid">
            <button class="btn btn-sm btn-primary" id="threshold-apply">Apply</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-2 mb-3">
    <div class="col-12 col-md-4">
      <div class="kpi-card">
        <div class="kpi-label">
          <i class="bi bi-droplet-half"></i>
          Overdue for oil change
        </div>
        <div class="kpi-value" id="kpi-oil-overdue">—</div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="kpi-card">
        <div class="kpi-label">
          <i class="bi bi-exclamation-octagon"></i>
          Deficiencies
        </div>
        <div class="kpi-value" id="kpi-deficient">—</div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="kpi-card">
        <div class="kpi-label">
          <i class="bi bi-clipboard-x"></i>
          Inspection overdue
        </div>
        <div class="kpi-value" id="kpi-inspection-overdue">—</div>
      </div>
    </div>
  </div>

  <!-- Buckets -->
  <div id="fleet-buckets" class="row g-3">
    <!-- shimmer placeholders -->
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body shimmer" style="height: 66px;"></div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body shimmer" style="height: 66px;"></div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body shimmer" style="height: 66px;"></div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body shimmer" style="height: 66px;"></div>
      </div>
    </div>
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body shimmer" style="height: 66px;"></div>
      </div>
    </div>
  </div>

  <!-- Change Status Modal -->
  <div class="modal fade" id="serviceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="serviceModalLabel">
            <i class="bi bi-wrench-adjustable-circle me-2"></i>Change Vehicle Status
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="small text-muted mb-2" id="serviceModalVehicleLabel">—</div>

          <label class="form-label small mb-1">Updated by</label>
          <input
            type="text"
            class="form-control form-control-sm mb-2"
            id="serviceModalUpdatedBy"
            placeholder="Your name"
            autocomplete="name"
          >

          <label class="form-label small mb-1">Status</label>
          <select class="form-select form-select-sm mb-2" id="serviceModalStatus">
            <option value="OK">OK</option>
            <option value="DUE">DUE</option>
            <option value="DEFICIENT">DEFICIENT</option>
            <option value="BOOKED">BOOKED</option>
            <option value="IN_SHOP">IN_SHOP</option>
          </select>

          <label class="form-label small mb-1">Office notes</label>
          <textarea class="form-control" id="serviceModalNotes" rows="4" placeholder="Optional. Empty will clear."></textarea>

          <div class="small text-muted mt-2" id="serviceModalMeta">—</div>
          <div class="alert alert-danger d-none mt-2 mb-0" id="serviceModalError"></div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-sm btn-primary" id="serviceModalSave">
            <i class="bi bi-save me-1"></i> Save
          </button>
        </div>

      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
  <script src="{{ url_for('static', filename='js/fleet_overview.js') }}"></script>
{% endblock %}
