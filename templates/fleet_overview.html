{# templates/vehicle_maintenance_home.html #}
{% extends "base.html" %}

{% block title %}Fleet Triage{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/fleet_overview.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4 fleet-overview">

  <!-- Header -->
  <div class="d-flex flex-column flex-md-row align-items-md-center gap-2 mb-3">
    <div class="me-auto">
      <h1 class="h4 mb-1 d-flex align-items-center gap-2">
        <i class="bi bi-truck"></i>
        Fleet Triage
      </h1>
      <div class="text-muted small" id="fleet-updated">Updated —</div>
    </div>

    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-sm btn-primary" href="{{ url_for('fleet.vehicle_inspection') }}">
        <i class="bi bi-clipboard-check me-1"></i> New Inspection
      </a>

      <button class="btn btn-sm btn-outline-secondary" id="fleet-refresh">
        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
      </button>

      <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="bi bi-sliders me-1"></i> Settings
        </button>
        <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 280px;">
          <div class="mb-2">
            <label class="form-label small mb-1">Inspection overdue after (days)</label>
            <input type="number" class="form-control form-control-sm" id="threshold-inspection-days" value="7" min="1" step="1">
          </div>
          <div class="d-grid">
            <button class="btn btn-sm btn-primary" id="threshold-apply">
              Apply
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs (triage counts) -->
  <div class="row g-3 mb-3" id="triage-kpis">
    <div class="col-6 col-lg-3">
      <div class="kpi-card shimmer">
        <div class="shimmer-line w-50"></div>
        <div class="shimmer-line w-35 mt-2"></div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="kpi-card shimmer">
        <div class="shimmer-line w-50"></div>
        <div class="shimmer-line w-35 mt-2"></div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="kpi-card shimmer">
        <div class="shimmer-line w-50"></div>
        <div class="shimmer-line w-35 mt-2"></div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="kpi-card shimmer">
        <div class="shimmer-line w-50"></div>
        <div class="shimmer-line w-35 mt-2"></div>
      </div>
    </div>
  </div>

  <!-- Two-lane triage board -->
  <div class="row g-3 mb-3">
    <!-- Lane A: Needs service -->
    <div class="col-12 col-lg-6">
      <div class="bucket-card bucket-card--danger">
        <div class="bucket-head">
          <div class="bucket-title">
            <i class="bi bi-tools me-2"></i>
            Needs Service Booking
          </div>
          <span class="badge text-bg-danger" id="needs-service-count">0</span>
        </div>

        <div class="bucket-body" id="needs-service-list">
          <div class="bucket-shimmer shimmer">
            <div class="shimmer-line w-75"></div>
            <div class="shimmer-line w-55 mt-2"></div>
            <div class="shimmer-line w-65 mt-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lane B: Overdue inspections -->
    <div class="col-12 col-lg-6">
      <div class="bucket-card bucket-card--warning">
        <div class="bucket-head">
          <div class="bucket-title">
            <i class="bi bi-clipboard-x me-2"></i>
            Overdue Inspections
          </div>
          <span class="badge text-bg-warning" id="overdue-inspections-count">0</span>
        </div>

        <div class="bucket-body" id="overdue-inspections-list">
          <div class="bucket-shimmer shimmer">
            <div class="shimmer-line w-75"></div>
            <div class="shimmer-line w-55 mt-2"></div>
            <div class="shimmer-line w-65 mt-2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- All vehicles (search + list) -->
  <div class="row g-3">
    <div class="col-12">
      <div class="bucket-card">
        <div class="bucket-head">
          <div class="bucket-title">
            <i class="bi bi-list-ul me-2"></i>
            All Vehicles
          </div>
          <span class="badge text-bg-secondary ms-auto" id="all-vehicles-count">0</span>
        </div>

        <div class="bucket-body">
          <div class="d-flex flex-column flex-md-row gap-2 align-items-md-center mb-2">
            <div class="me-auto w-100">
              <input
                type="text"
                class="form-control form-control-sm"
                id="fleet-all-search"
                placeholder="Search by tech, make/model, or license plate…"
                autocomplete="off"
              >
            </div>
            <div class="text-muted small" id="all-vehicles-hint">
              Click a vehicle to view details.
            </div>
          </div>

          <div id="fleet-all-list">
            <div class="vehicle-item shimmer" style="height: 54px;"></div>
            <div class="vehicle-item shimmer" style="height: 54px;"></div>
            <div class="vehicle-item shimmer" style="height: 54px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lightweight edit modal (Bootstrap) -->
  <div class="modal fade" id="serviceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="serviceModalLabel">
            <i class="bi bi-wrench-adjustable-circle me-2"></i>Service Notes
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="small text-muted mb-2" id="serviceModalVehicleLabel">—</div>

          <label class="form-label small mb-1">Service status</label>
          <select class="form-select form-select-sm mb-2" id="serviceModalStatus">
            <option value="DUE">DUE</option>
            <option value="BOOKED">BOOKED</option>
            <option value="OK">OK</option>
          </select>

          <label class="form-label small mb-1">Office notes</label>
          <textarea class="form-control" id="serviceModalNotes" rows="4" placeholder="Add/edit office notes. Empty will clear."></textarea>

          <div class="row g-2 mt-2">
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Last service date (optional)</label>
              <input type="date" class="form-control form-control-sm" id="serviceModalLastServiceDate">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Quick action</label>
              <div class="d-grid gap-2">
                <button class="btn btn-sm btn-outline-success" id="serviceModalMarkDone">
                  <i class="bi bi-check2-circle me-1"></i> Mark OK + set date to today
                </button>
              </div>
            </div>
          </div>

          <div class="small text-muted mt-2" id="serviceModalMeta">—</div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-sm btn-primary" id="serviceModalSave">
            <i class="bi bi-save me-1"></i> Save
          </button>
        </div>

      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
  <script src="{{ url_for('static', filename='js/fleet_overview.js') }}"></script>
{% endblock %}
