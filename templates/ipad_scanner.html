{% extends "base.html" %}
{% block title %}iPad Scanner{% endblock %}

{% block extra_head %}
<!-- You can add page-specific CSS here -->
{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2 class="text-center">iPad Barcode Scanner</h2>

    <button id="start-btn" class="btn btn-primary w-100 mt-3">Start Scanner</button>

    <div id="scanner-container" 
        style="display:none; margin-top:20px; position:relative;">
        <video id="video" style="width:100%; border-radius:10px;" playsinline></video>

        <div id="scanner-overlay"
            style="position:absolute; top:0; left:0; right:0; bottom:0; border:3px solid rgba(0,255,0,0.4);">
        </div>
    </div>


    <p id="message" class="text-center mt-3 text-muted">
        Tap ‚ÄúStart Scanner‚Äù to begin.
    </p>

</div>
{% endblock %}

{% block extra_scripts %}
<script type="text/javascript" src="https://unpkg.com/@zxing/browser@latest"></script>
<script type="text/javascript">
window.addEventListener('load', async function () {

    console.log("üåê Page loaded.");

    const codeReader = new ZXingBrowser.BrowserQRCodeReader();
    console.log("üì¶ ZXing initialized:", codeReader);

    try {
        const videoInputDevices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
        console.log("üé• Video devices:", videoInputDevices);

        if (devices.length === 0) {
            console.error("‚ùå No cameras found.");
            alert("No camera available.");
            return;
        }

        let selectedDeviceId =
            devices.find(d => d.label.toLowerCase().includes("back"))?.deviceId
            || devices[0].deviceId;

        console.log("üì∏ Using camera:", selectedDeviceId);

        const previewElem = document.createElement("video");
        previewElem.setAttribute("playsinline", true);
        previewElem.style.width = "100%";
        document.body.appendChild(previewElem);

        console.log("üîç Starting decode...");

        codeReader.decodeFromVideoDevice(
            selectedDeviceId,
            previewElem,
            (result, err) => {
                if (result) {
                    console.log("üéâ BARCODE FOUND:", result.text);
                    alert("Decoded: " + result.text);
                    codeReader.reset();
                }
                if (err && !(err instanceof ZXing.NotFoundException)) {
                    console.warn("‚ö†Ô∏è Scan error:", err);
                }
            }
        );

    }catch (err){
        console.log(err);
    }
});
</script>
{% endblock %}

