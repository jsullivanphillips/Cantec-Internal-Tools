{% extends "base.html" %}
{% block title %}iPad Scanner{% endblock %}

{% block extra_head %}
<!-- You can add page-specific CSS here -->
{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2 class="text-center">iPad Barcode Scanner</h2>

    <button id="start-btn" class="btn btn-primary w-100 mt-3">Start Scanner</button>

    <div id="scanner-container" 
        style="display:none; margin-top:20px; position:relative;">
        <video id="video" style="width:100%; border-radius:10px;" playsinline></video>

        <div id="scanner-overlay"
            style="position:absolute; top:0; left:0; right:0; bottom:0; border:3px solid rgba(0,255,0,0.4);">
        </div>
    </div>

    <p id="message" class="text-center mt-3 text-muted">
        Tap â€œStart Scannerâ€ to begin.
    </p>

</div>
{% endblock %}

{% block extra_scripts %}
<script type="text/javascript" src="https://unpkg.com/@zxing/browser@latest"></script>
<script>
window.addEventListener('load', async () => {
    console.log("ğŸŒ Page loaded.");

    const startBtn = document.getElementById("start-btn");
    const scannerContainer = document.getElementById("scanner-container");
    const videoElem = document.getElementById("video");

    startBtn.addEventListener("click", startCamera);

    async function startCamera() {
        console.log("â–¶ï¸ Starting cameraâ€¦");

        scannerContainer.style.display = "block";

        // MUST SET FOR SAFARI
        videoElem.setAttribute("playsinline", true);
        videoElem.setAttribute("webkit-playsinline", true);
        videoElem.muted = true;

        // Setup ZXing
        const reader = new ZXingBrowser.BrowserQRCodeReader();
        console.log("ğŸ“¦ ZXing loaded:", reader);

        try {
            // Get list of cameras
            const devices = await reader.listVideoInputDevices();
            console.log("ğŸ¥ Cameras:", devices);

            if (devices.length === 0) {
                alert("No camera found.");
                return;
            }

            // Use BACK camera if available
            const backCam =
                devices.find(d => d.label.toLowerCase().includes("back")) ||
                devices[0];

            console.log("ğŸ“¸ Using camera:", backCam);

            // Start the video stream ONLY
            const controls = await reader.decodeFromVideoDevice(
                backCam.deviceId,
                videoElem,
                () => {} // no decoding yet
            );

            console.log("â–¶ï¸ Camera stream started.");

        } catch (err) {
            console.error("âŒ Camera error:", err);
        }
    }
});
</script>
{% endblock %}

